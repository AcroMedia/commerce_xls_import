<?php

/**
 * @file
 * Commerce_xls_import.test.
 *
 * Tests.
 */

/**
 * Class CommerceXlsImportTestCase.
 */
class CommerceXlsImportTestCase extends DrupalWebTestCase {
  protected $adminUser;
  protected $privilegedUser;
  protected $normalUser;

  /**
   * GetInfo().
   *
   * @return array
   *  An array containing name, description, and group text.
   */
  public static function getInfo() {
    return array(
      'name' => 'Commerce XLS Import Tests',
      'description' => 'Ensure Commerce XLS Import functions properly',
      'group' => 'Drupal Commerce XLS Import',
    );
  }

  /**
   * Setup().
   * @{inheritdoc}
   */
  public function setUp() {

    parent::setUp(array('commerce_product_ui', 'commerce_xls_import'));

    $this->adminUser = $this->drupalCreateUser(array(
      'administer users',
      'administer permissions',
    ));

    $this->privilegedUser = $this->drupalCreateUser(array(
      'administer commerce import',
      'administer commerce_product entities',
    ));

    $this->normalUser = $this->drupalCreateUser();
  }

  /**
   * Test permissions.
   */
  public function testCommerceXlsImportPermissions() {
    $this->drupalLogin($this->privilegedUser);
    $this->drupalGet('admin/commerce/products/import_commerce');
    $this->assertResponse('200', 'Privileged user was able to correctly access the admin page');

    $this->drupalLogin($this->normalUser);
    $this->drupalGet('admin/commerce/products/import_commerce');
    $this->assertResponse('403', 'Unprivileged user was unable to access the admin page');
  }

  /**
   * Test product types
   */
  public function testCommerceXlsImportProductTypes() {
    $this->drupalLogin($this->privilegedUser);
    $this->drupalGet('admin/commerce/products/import_commerce');
    $this->assertFieldByXPath("//select[@name='product_type']/option[@value='product']", 'Product', 'Product type \'Product\' found');
  }

  /**
   * Test xls upload
   */
  public function testCommerceXlsImportUpload() {
    $this->drupalLogin($this->privilegedUser);

    $edit = array(
      'product_type' => 'product',
      'files[import_file]' => drupal_get_path('module', 'commerce_xls_import') . '/sample_files/sample.xls',
      'files[product_images]' => drupal_get_path('module', 'commerce_xls_import') . '/sample_files/product_images.zip',
    );
    $this->drupalPost('admin/commerce/products/import_commerce', $edit, 'Validate File');
    $this->assertText('24 products successfully processed', 'XLS File Validation is Running');
  }

  /**
   * Test xls import
   */
  public function testCommerceXlsImportImport() {
    $this->drupalLogin($this->privilegedUser);

    $edit = array(
      'product_type' => 'product',
      'files[import_file]' => drupal_get_path('module', 'commerce_xls_import') . '/sample_files/sample.xls',
      'files[product_images]' => drupal_get_path('module', 'commerce_xls_import') . '/sample_files/product_images.zip',
    );
    $this->drupalPost('admin/commerce/products/import_commerce', $edit, 'Begin Full Import');
    $this->assertText('24 products successfully processed', 'XLS File processed');

    $this->drupalGet('admin/commerce/products');

    libraries_load('PHPExcel');
    module_load_include('inc', 'phpexcel', 'phpexcel');
    //Loop thru xls and check if all skus are in the product page, make sure #18 and above do not appear (no sku)
    $result = phpexcel_import(drupal_get_path('module', 'commerce_xls_import') . '/sample_files/sample.xls');
    foreach ($result[0] as $index => $row) {
      if ($index < 18) {
        //Valid Sku
        $this->assertText($row['sku'], $row['title'] . ':' . $row['sku'] . ' found');
      } else {
        //Invalid Sku
        $this->assertNoText($row['title'], $row['title'] . ':' . $row['sku'] . ' not found');
      }
    }
  }
}
